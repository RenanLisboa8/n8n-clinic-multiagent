{
  "name": "03 - Appointment Confirmation Scheduler",
  "nodes": [
    {
      "parameters": {
        "content": "## üìã 03 - Appointment Confirmation Scheduler\n\n**Vers√£o**: 3.0 - Refatorado com base no Material Secret√°ria v3\n\n### üéØ Funcionalidades Principais\n- ‚úÖ Envia lembretes de confirma√ß√£o para agendamentos do dia seguinte\n- ‚úÖ Suporte completo a m√∫ltiplos profissionais\n- ‚úÖ Processa todos os tenants automaticamente\n- ‚úÖ Extrai informa√ß√µes do paciente da descri√ß√£o do evento\n- ‚úÖ Mensagem personalizada com nome do profissional\n\n### ‚è∞ Agendamento\n- **Hor√°rio**: 8h da manh√£ (segunda a sexta)\n- **Timezone**: Respeita timezone de cada cl√≠nica\n- **Per√≠odo**: Agendamentos do dia seguinte (amanh√£)\n\n### üîÑ Fluxo de Processamento\n1. **Trigger**: Executa diariamente √†s 8h (seg-sex)\n2. **Carrega Profissionais**: Busca todos os profissionais ativos de todos os tenants\n3. **Loop por Profissional**: Para cada profissional:\n   - Busca agendamentos do calend√°rio dele\n   - Extrai informa√ß√µes do paciente (nome, telefone)\n   - Prepara mensagem de confirma√ß√£o\n   - Envia via WhatsApp\n4. **Rate Limiting**: Espera 2 segundos entre envios\n\n### üìä Caracter√≠sticas Multi-Profissional\n- Processa todos os calend√°rios de profissionais separadamente\n- Inclui nome do profissional na mensagem\n- Usa `evolution_instance_name` correto de cada tenant\n- Respeita `timezone` de cada cl√≠nica\n\n### üìù Formato da Mensagem\n- Sauda√ß√£o personalizada com nome do paciente\n- Data e hor√°rio formatados\n- Nome do profissional\n- Endere√ßo da cl√≠nica\n- Op√ß√µes de resposta (CONFIRMAR, REAGENDAR, CANCELAR)\n\n### ‚ö†Ô∏è Valida√ß√µes\n- Apenas agendamentos com telefone v√°lido s√£o processados\n- Agendamentos sem telefone s√£o logados e pulados\n- Rate limiting de 2 segundos entre envios",
        "height": 700,
        "width": 500,
        "color": 5
      },
      "id": "documentation-sticky",
      "name": "Sticky Note - Documenta√ß√£o Principal",
      "type": "n8n-nodes-base.stickyNote",
      "position": [0, 0],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * 1-5"
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Daily Trigger (8 AM Mon-Fri)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [240, 400],
      "typeVersion": 1.2,
      "notes": "‚è∞ Trigger agendado para executar diariamente √†s 8h (segunda a sexta)\n\n**Cron**: `0 8 * * 1-5`\n**Timezone**: UTC (ajustado por timezone da cl√≠nica)\n**Frequ√™ncia**: Uma vez por dia, apenas em dias √∫teis"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "tomorrow_date",
              "name": "tomorrow_date",
              "type": "string",
              "value": "={{ $now.plus({days: 1}).toFormat('yyyy-MM-dd') }}"
            },
            {
              "id": "trigger_time",
              "name": "trigger_time",
              "type": "string",
              "value": "={{ $now }}"
            }
          ]
        }
      },
      "id": "prepare-dates",
      "name": "Prepare Dates",
      "type": "n8n-nodes-base.set",
      "position": [460, 400],
      "typeVersion": 3.4,
      "notes": "üìÖ Prepara datas para busca de agendamentos\n\n**Campos**:\n- `tomorrow_date` - Data de amanh√£ no formato YYYY-MM-DD\n- `trigger_time` - Timestamp do trigger (para logs)\n\n**Uso**: Define o per√≠odo de busca (dia seguinte)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT DISTINCT \n  p.professional_id,\n  p.professional_name,\n  p.google_calendar_id,\n  p.tenant_id,\n  tc.clinic_name,\n  tc.evolution_instance_name,\n  tc.clinic_address,\n  tc.timezone\nFROM professionals p\nJOIN tenant_config tc ON p.tenant_id = tc.tenant_id\nWHERE p.is_active = true\n  AND tc.is_active = true\n  AND p.google_calendar_id IS NOT NULL\nORDER BY tc.tenant_name, p.display_order;",
        "options": {}
      },
      "id": "load-professionals",
      "name": "Load All Active Professionals",
      "type": "n8n-nodes-base.postgres",
      "position": [680, 400],
      "typeVersion": 2.4,
      "credentials": {
        "postgres": {
          "id": "{{POSTGRES_CREDENTIAL_ID}}",
          "name": "Postgres account"
        }
      },
      "notes": "üìã Carrega todos os profissionais ativos com seus calendar IDs\n\n**Query**: Busca profissionais ativos de todos os tenants ativos\n**Retorna**:\n- `professional_id` - UUID do profissional\n- `professional_name` - Nome do profissional\n- `google_calendar_id` - ID do calend√°rio do Google Calendar\n- `tenant_id` - UUID do tenant\n- `clinic_name` - Nome da cl√≠nica\n- `evolution_instance_name` - Inst√¢ncia Evolution API\n- `clinic_address` - Endere√ßo da cl√≠nica\n- `timezone` - Timezone da cl√≠nica\n\n**Ordena√ß√£o**: Por `tenant_name` e `display_order` do profissional"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop-professionals",
      "name": "Loop Over Professionals",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [900, 400],
      "typeVersion": 3.1
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendarId": "={{ $json.google_calendar_id }}",
        "returnAll": true,
        "options": {
          "timeMax": "={{ $('Prepare Dates').item.json.tomorrow_date }}T23:59:59-03:00",
          "timeMin": "={{ $('Prepare Dates').item.json.tomorrow_date }}T00:00:00-03:00"
        }
      },
      "id": "fetch-appointments",
      "name": "Fetch Tomorrow's Appointments",
      "type": "n8n-nodes-base.googleCalendar",
      "position": [1120, 400],
      "typeVersion": 1.2,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "{{GOOGLE_CALENDAR_CREDENTIAL_ID}}",
          "name": "Google Calendar"
        }
      },
      "notes": "üìÖ Busca agendamentos do calend√°rio deste profissional\n\n**Per√≠odo**: Amanh√£ (00:00:00 at√© 23:59:59)\n**Calend√°rio**: `google_calendar_id` do profissional\n**Timezone**: Considera timezone da cl√≠nica\n**Retorna**: Todos os eventos do dia seguinte\n\n**Processamento**: Cada profissional √© processado separadamente para suporte multi-profissional"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop-appointments",
      "name": "Loop Over Appointments",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [1340, 400],
      "typeVersion": 3.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "patient_name",
              "name": "patient_name",
              "type": "string",
              "value": "={{ $json.summary }}"
            },
            {
              "id": "appointment_time",
              "name": "appointment_time",
              "type": "string",
              "value": "={{ $json.start.dateTime }}"
            },
            {
              "id": "phone_number",
              "name": "phone_number",
              "type": "string",
              "value": "={{ $json.description?.match(/\\d{10,15}/)?.[0] || '' }}"
            },
            {
              "id": "event_id",
              "name": "event_id",
              "type": "string",
              "value": "={{ $json.id }}"
            },
            {
              "id": "professional_name",
              "name": "professional_name",
              "type": "string",
              "value": "={{ $('Loop Over Professionals').item.json.professional_name }}"
            },
            {
              "id": "clinic_name",
              "name": "clinic_name",
              "type": "string",
              "value": "={{ $('Loop Over Professionals').item.json.clinic_name }}"
            },
            {
              "id": "clinic_address",
              "name": "clinic_address",
              "type": "string",
              "value": "={{ $('Loop Over Professionals').item.json.clinic_address }}"
            },
            {
              "id": "evolution_instance_name",
              "name": "evolution_instance_name",
              "type": "string",
              "value": "={{ $('Loop Over Professionals').item.json.evolution_instance_name }}"
            }
          ]
        }
      },
      "id": "extract-contact",
      "name": "Extract Patient Contact",
      "type": "n8n-nodes-base.set",
      "position": [1560, 400],
      "typeVersion": 3.4,
      "notes": "üìù Extrai informa√ß√µes de contato do paciente do evento\n\n**Extrai**:\n- `patient_name` - Do campo `summary` do evento\n- `appointment_time` - Do campo `start.dateTime`\n- `phone_number` - Regex da descri√ß√£o (\\d{10,15})\n- `event_id` - ID do evento no Google Calendar\n- `professional_name` - Do loop de profissionais\n- `clinic_name` - Do tenant config\n- `clinic_address` - Do tenant config\n- `evolution_instance_name` - Para envio WhatsApp\n\n**Valida√ß√£o**: Telefone √© extra√≠do via regex da descri√ß√£o"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "leftValue": "={{ $json.phone_number }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "has-phone",
      "name": "Has Phone?",
      "type": "n8n-nodes-base.if",
      "position": [1780, 400],
      "typeVersion": 2.1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "confirmation_message",
              "name": "confirmation_message",
              "type": "string",
              "value": "=Ol√°, *{{ $json.patient_name }}*! üëã\n\nEste √© um lembrete da *{{ $json.clinic_name }}*.\n\nVoc√™ tem uma consulta agendada para:\nüìÖ *Amanh√£* √†s *{{ $json.appointment_time }}*\nüë®‚Äç‚öïÔ∏è *{{ $json.professional_name }}*\nüìç {{ $json.clinic_address || 'Consulte endere√ßo da cl√≠nica' }}\n\nPor favor, responda:\n‚úÖ *CONFIRMAR* - Para confirmar presen√ßa\nüìÖ *REAGENDAR* - Se precisar mudar o hor√°rio\n‚ùå *CANCELAR* - Para cancelar\n\nAguardamos seu retorno! üôÇ"
            },
            {
              "id": "remote_jid",
              "name": "remote_jid",
              "type": "string",
              "value": "={{ $json.phone_number }}@s.whatsapp.net"
            }
          ]
        }
      },
      "id": "prepare-confirmation",
      "name": "Prepare Confirmation Message",
      "type": "n8n-nodes-base.set",
      "position": [2000, 300],
      "typeVersion": 3.4,
      "notes": "üí¨ Prepara mensagem de confirma√ß√£o personalizada\n\n**Conte√∫do**:\n- Sauda√ß√£o com nome do paciente\n- Lembrete da consulta (amanh√£)\n- Data e hor√°rio formatados\n- Nome do profissional\n- Endere√ßo da cl√≠nica\n- Op√ß√µes de resposta (CONFIRMAR, REAGENDAR, CANCELAR)\n\n**Formato**: Mensagem WhatsApp com emojis e formata√ß√£o"
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "seconds"
      },
      "id": "wait",
      "name": "Wait (Rate Limit)",
      "type": "n8n-nodes-base.wait",
      "position": [2220, 300],
      "typeVersion": 1.1,
      "webhookId": "confirmation-wait",
      "notes": "‚è≥ Espera de 2 segundos entre envios (rate limiting)\n\n**Motivo**: Evitar bloqueio por spam da Evolution API\n**Dura√ß√£o**: 2 segundos\n**Aplicado**: Entre cada envio de confirma√ß√£o"
    },
    {
      "parameters": {
        "workflow": "={{ 'WhatsApp Send Tool' }}",
        "options": {
          "fieldMapping": {
            "mappingMode": "defineBelow",
            "values": {
              "instance_name": "={{ $json.evolution_instance_name }}",
              "remote_jid": "={{ $json.remote_jid }}",
              "message_text": "={{ $json.confirmation_message }}"
            }
          }
        }
      },
      "id": "send-confirmation",
      "name": "Send Confirmation",
      "type": "n8n-nodes-base.executeWorkflow",
      "position": [2440, 300],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "log_entry",
              "name": "log_entry",
              "type": "string",
              "value": "=Confirmation sent to {{ $json.patient_name }} ({{ $json.phone_number }})"
            },
            {
              "id": "success",
              "name": "success",
              "type": "boolean",
              "value": "=true"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "type": "string",
              "value": "={{ $now }}"
            }
          ]
        }
      },
      "id": "log-success",
      "name": "Log Success",
      "type": "n8n-nodes-base.set",
      "position": [2660, 300],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "log_entry",
              "name": "log_entry",
              "type": "string",
              "value": "=Skipped {{ $json.patient_name }} - No phone number"
            },
            {
              "id": "success",
              "name": "success",
              "type": "boolean",
              "value": "=false"
            },
            {
              "id": "reason",
              "name": "reason",
              "type": "string",
              "value": "no_phone"
            }
          ]
        }
      },
      "id": "log-skip",
      "name": "Log Skip",
      "type": "n8n-nodes-base.set",
      "position": [2000, 500],
      "typeVersion": 3.4
    }
  ],
  "pinData": {},
  "connections": {
    "Daily Trigger (8 AM Mon-Fri)": {
      "main": [
        [
          {
            "node": "Prepare Dates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Dates": {
      "main": [
        [
          {
            "node": "Load All Active Professionals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load All Active Professionals": {
      "main": [
        [
          {
            "node": "Loop Over Professionals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Professionals": {
      "main": [
        [
          {
            "node": "Fetch Tomorrow's Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Tomorrow's Appointments": {
      "main": [
        [
          {
            "node": "Loop Over Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Appointments": {
      "main": [
        [
          {
            "node": "Extract Patient Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Patient Contact": {
      "main": [
        [
          {
            "node": "Has Phone?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Phone?": {
      "main": [
        [
          {
            "node": "Prepare Confirmation Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Skip",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Confirmation Message": {
      "main": [
        [
          {
            "node": "Wait (Rate Limit)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait (Rate Limit)": {
      "main": [
        [
          {
            "node": "Send Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmation": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Loop Over Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Skip": {
      "main": [
        [
          {
            "node": "Loop Over Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Appointments": {
      "main": [
        [
          {
            "node": "Loop Over Professionals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "={{ $env.ERROR_WORKFLOW_ID || '04 - Error Handler' }}"
  },
  "versionId": "main-confirmation-scheduler-v1",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "clinic-multiagent-system"
  },
  "tags": [
    {
      "name": "main",
      "id": "10"
    },
    {
      "name": "production",
      "id": "11"
    },
    {
      "name": "scheduled",
      "id": "12"
    }
  ]
}








