-- ============================================================================
-- MIGRATION 016: NUMBERED SERVICES CATALOG
-- Version: 1.0.0
-- Date: 2026-01-11
-- Description: Modifies get_services_catalog_for_prompt() to number services
--              for easier customer selection (1, 2, 3... instead of bullets)
-- ============================================================================

-- ============================================================================
-- MODIFY: get_services_catalog_for_prompt() - Add numbering to services
-- ============================================================================

CREATE OR REPLACE FUNCTION get_services_catalog_for_prompt(p_tenant_id UUID)
RETURNS TEXT AS $$
DECLARE
    v_catalog TEXT := '';
    v_current_category TEXT := '';
    v_current_professional TEXT := '';
    v_category_emoji TEXT;
    v_service_counter INTEGER := 0;
    rec RECORD;
BEGIN
    -- Build catalog with sequential numbering across all services
    FOR rec IN 
        SELECT 
            sc.service_category,
            p.professional_name,
            p.professional_title,
            p.specialty,
            p.display_order as prof_display_order,
            sc.service_name,
            ps.custom_duration_minutes,
            COALESCE(ps.price_display, format('R$ %s', to_char(ps.custom_price_cents / 100.0, 'FM999999990.00'))) as price_display,
            sc.display_order as service_display_order
        FROM professionals p
        JOIN professional_services ps ON p.professional_id = ps.professional_id
        JOIN services_catalog sc ON ps.service_id = sc.service_id
        WHERE p.tenant_id = p_tenant_id
        AND p.is_active = true
        AND ps.is_active = true
        AND sc.is_active = true
        ORDER BY p.display_order, sc.service_category, sc.display_order, sc.service_name
    LOOP
        -- Add category header if changed
        IF v_current_category IS DISTINCT FROM rec.service_category THEN
            -- Map category to emoji
            v_category_emoji := CASE rec.service_category
                WHEN 'Odontologia' THEN 'ü¶∑'
                WHEN 'Est√©tica' THEN 'üíÜ'
                WHEN 'Cardiologia' THEN '‚ù§Ô∏è'
                WHEN 'Cl√≠nico Geral' THEN 'üë®‚Äç‚öïÔ∏è'
                ELSE 'üìã'
            END;
            
            IF v_catalog != '' THEN
                v_catalog := v_catalog || E'\n';
            END IF;
            
            v_catalog := v_catalog || format('%s *%s* - %s %s (%s)',
                v_category_emoji,
                UPPER(rec.service_category),
                COALESCE(rec.professional_title, ''),
                rec.professional_name,
                rec.specialty
            );
            v_current_category := rec.service_category;
            v_current_professional := rec.professional_name;
        ELSIF v_current_professional IS DISTINCT FROM rec.professional_name THEN
            -- Same category, different professional - add professional header
            IF v_catalog != '' THEN
                v_catalog := v_catalog || E'\n';
            END IF;
            
            v_catalog := v_catalog || format('%s *%s* - %s %s (%s)',
                v_category_emoji,
                UPPER(rec.service_category),
                COALESCE(rec.professional_title, ''),
                rec.professional_name,
                rec.specialty
            );
            v_current_professional := rec.professional_name;
        END IF;
        
        -- Add service with sequential numbering
        v_service_counter := v_service_counter + 1;
        
        v_catalog := v_catalog || E'\n' || format('%s. %s: %s | %s',
            v_service_counter::TEXT,
            rec.service_name,
            CASE 
                WHEN rec.custom_duration_minutes < 60 THEN format('%smin', rec.custom_duration_minutes::TEXT)
                WHEN rec.custom_duration_minutes = 60 THEN '1h'
                ELSE format('%sh%smin', 
                    (rec.custom_duration_minutes / 60)::TEXT,
                    (rec.custom_duration_minutes % 60)::TEXT
                )
            END,
            rec.price_display
        );
    END LOOP;
    
    RETURN COALESCE(v_catalog, 'Nenhum servi√ßo cadastrado.');
END;
$$ LANGUAGE plpgsql;

-- Grant permissions (if role exists)
DO $$ 
BEGIN
    IF EXISTS (SELECT FROM pg_roles WHERE rolname = 'n8n_user') THEN
        GRANT EXECUTE ON FUNCTION get_services_catalog_for_prompt(UUID) TO n8n_user;
    END IF;
END $$;

COMMENT ON FUNCTION get_services_catalog_for_prompt(UUID) IS 'Returns formatted services catalog with numbered options (1, 2, 3...) for customer selection';
